#!/bin/bash
#
# $Id$
#
# Delivery of the Web site in a DocumentRoot
#
#
# Please replace with your destination
#
LOCALDIR=/var/www/html/mondo
DESTUSER=apache
MONDODIR=/mondo/www/html/mondo
TESTDIR=/mondo/www/html/test

/sbin/ifconfig | grep -q 10.3 2>&1 > /dev/null
if [ $? = 0 ]; then
	DESTMACH=mondo.hpintelco.org
else
	DESTMACH=www1.mondorescue.org
fi

dname=`dirname $0`
prem=`echo $dname |cut -c1`
if [ ${prem} == "/" ]; then
        export TOOLHOME=$dname
else
        export TOOLHOME=${PWD}/$dname
fi

. $TOOLHOME/common-env

rm -rf $LOCALDIR
cp -a ${BASE}/svn/${VER}/website $LOCALDIR
(cd ${BASE}/svn/${VER}/documentation ; make)
mkdir -p $LOCALDIR/docs
cp -a ${BASE}/svn/${VER}/documentation/* $LOCALDIR/docs
#
# Man pages corrections
#
perl -pi -e 's~/man8/~/docs/~g' $LOCALDIR/docs/*.8.html
perl -pi -e 's~<A HREF[=./A-z0-9"]*/man1/[^<]*>([A-z0-9]*)</A>~$1~g' $LOCALDIR/docs/*.8.html
perl -pi -e 's~/index.html~/index.shtml~' $LOCALDIR/docs/*.8.html 
find $LOCALDIR -type d | xargs chmod 755
find $LOCALDIR -type f | xargs chmod 644
cd $LOCALDIR
if [ _"$1" == _"" ]; then
		exit 0
else
	if [ _"$1" == _"test" ]; then
		DESTDIR=$TESTDIR
	else
		DESTDIR=$MONDODIR
	fi
fi
tar cfz /tmp/mondo-www.tgz .
ssh ${DESTUSER}@${DESTMACH} "rm -rf ${DESTDIR} ; mkdir ${DESTDIR}"
scp /tmp/mondo-www.tgz ${DESTUSER}@${DESTMACH}:/tmp
rm -f /tmp/mondo-www.tgz
ssh ${DESTUSER}@${DESTMACH} "cd ${DESTDIR} ; tar xfz /tmp/mondo-www.tgz"
